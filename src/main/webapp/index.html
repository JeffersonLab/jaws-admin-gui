<html>
<body>
<h1>JAWS Web Proxy</h1>
<h2>Registered Alarms</h2>
<div style="border: 2px solid black; padding: 1em;">
    <h3>Edit Form</h3>
    <form id="registered-form" onsubmit="return false;">
        <ul>
            <li>Alarm Name: <input type="text" name="name" value=""/></li>
            <li>Class: <select name="class" id="class-select"></select></li>
        </ul>
        <h4>Class Overrides (Leave blank to inherit from class)</h4>
        <ul>
            <li>Location: <span id="registered-location-select-span"></span></li>
            <li>Category: <span id="registered-category-select-span"></span></li>
            <li>Rationale: <input type="text" name="rationale" value=""/></li>
            <li>Filterable: (True <input type="radio" name="filterable" value="true"/>)   (False <input type="radio" name="filterable" value="false"/>)   (Inherit <input type="radio" name="filterable" checked="checked" value=""/>)</li>
            <li>Latching: (True <input type="radio" name="latching" value="true"/>)   (False <input type="radio" name="latching" value="false"/>)   (Inherit <input type="radio" name="latching" checked="checked" value=""/>)</li>
            <li>On Delay Seconds: <input type="number" name="ondelayseconds" value=""/></li>
            <li>Off Delay Seconds: <input type="number" name="offdelayseconds" value=""/></li>
            <li>Masked By: <input type="text" name="maskedby" value=""/></li>
            <li>Screen Path: <input type="text" name="screenpath" value=""/></li>
        </ul>

        <input id="registered-submit" type="button" value="Set"/>
    </form>
</div>
<script>
    let button = document.getElementById('registered-submit');

    button.addEventListener("click", function(e) {
        let form = document.getElementById("registered-form"),
            formData = new FormData(form);

        /*Treat empty string as no-field*/
        for(var pair of Array.from(formData.entries())) {
            if(pair[1] === "") {
                console.log('deleting: ', pair);
                formData.delete(pair[0]);
            } else {
                console.log('keeping: ', pair)
            }
        }

        let promise = fetch("proxy/rest/registered", {
            method: "PUT",
            body: new URLSearchParams(formData),
            headers: {
                "Content-type": 'application/x-www-form-urlencoded;charset=UTF-8'
            }
        });

        form.reset();
    });
</script>
<div style="border: 2px solid black; padding: 1em;">
<h2>Inventory Table</h2>
<table id="registered-table">
    <thead>
    <tr>
        <th></th>
        <th>Alarm Name</th>
        <th>Priority</th>
        <th>Producer</th>
        <th>Class</th>
        <th>Location</th>
        <th>Category</th>
        <th>Rationale</th>
        <th>Corrective Action</th>
        <th>Point of Contact Username</th>
        <th>Filterable</th>
        <th>Latching</th>
        <th>On Delay Seconds</th>
        <th>Off Delay Seconds</th>
        <th>Masked By</th>
        <th>Screen Path</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
</div>
<h2>Alarm Classes</h2>
<div style="border: 2px solid black; padding: 1em;">
    <h3>Edit Form</h3>
    <form id="class-form" onsubmit="return false;">
        <ul>
            <li>Class Name: <input type="text" name="name" value=""/></li>
            <li>Location: <select name="location" id="location-select"></select></li>
            <li>Category: <select name="category" id="category-select"></select></li>
        </ul>

        <input id="class-submit" type="button" value="Set"/>
    </form>
</div>
<script>
    let classButton = document.getElementById('class-submit');

    classButton.addEventListener("click", function(e) {
        let form = document.getElementById("class-form");

        let promise = fetch("proxy/rest/class", {
            method: "PUT",
            body: new URLSearchParams(new FormData(form)),
            headers: {
                "Content-type": 'application/x-www-form-urlencoded;charset=UTF-8'
            }
        });

        form.reset();
    });
</script>
<div style="border: 2px solid black; padding: 1em;">
<h3>Inventory Table</h3>
<table id="class-table">
    <thead>
        <tr>
            <th>Class Name</th>
            <th>Location</th>
            <th>Category</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>
<script>
    let evtSource = new EventSource('proxy/sse'),
        registeredTable = document.getElementById('registered-table'),
        registeredTableBody = registeredTable.getElementsByTagName("tbody")[0],
        classTable = document.getElementById('class-table');
        classTableBody = classTable.getElementsByTagName("tbody")[0];

    console.log('attempting sse...')

    evtSource.addEventListener("registration", function(e) {
        console.log('registration type message')
        let json = JSON.parse(e.data),
            key = json.key,
            value = json.value;

        console.log(json);

        keys = document.querySelectorAll("#registered-table tbody tr td:nth-child(2)");

        keys.forEach(
            function(td, index, list) {
                if(key === td.textContent) {
                    console.log('match: ', key, td.textContent);
                    registeredTableBody.deleteRow(index);
                } else {
                    console.log('no match: ', key, td.textContent, index, list);
                }
            }
        );

        if(value === null) {
            console.log("tombstone encountered");
            return;
        }

        let insertNullableText = function(text, row, index) {
            if(text != null) {
                text = Object.values(text)[0];
            }
            let cell = row.insertCell(index++);
            cell.appendChild(document.createTextNode(text));
        };

        let index = 0;

        let row = registeredTableBody.insertRow(-1),
            cell = row.insertCell(index++);

        let deleteBtn = document.createElement('input');
        deleteBtn.type = "button";
        deleteBtn.value = "X";
        deleteBtn.onclick = function() {

            console.log('attempting to delete: ', key);

            let params = "name=" + key;

            let promise = fetch("proxy/rest/registered", {
                method: "DELETE",
                body: new URLSearchParams(params),
                headers: {
                    "Content-type": 'application/x-www-form-urlencoded;charset=UTF-8'
                }
            });
        };
        cell.append(deleteBtn)

        cell = row.insertCell(index++);
        cell.appendChild(document.createTextNode(key));

        insertNullableText(value.priority, row, index++);

        cell = row.insertCell(index++);
        cell.appendChild(document.createTextNode(JSON.stringify(value.producer)));

        cell = row.insertCell(index++);
        cell.appendChild(document.createTextNode(value.class));

        insertNullableText(value.location, row, index++);
        insertNullableText(value.category, row, index++);
        insertNullableText(value.rationale, row, index++);
        insertNullableText(value.correctiveaction, row, index++);
        insertNullableText(value.pointofcontactusername, row, index++);
        insertNullableText(value.filterable, row, index++);
        insertNullableText(value.latching, row, index++);
        insertNullableText(value.ondelayseconds, row, index++);
        insertNullableText(value.offdelayseconds, row, index++);
        insertNullableText(value.maskedby, row, index++);
        insertNullableText(value.screenpath, row, index++);
    });

    evtSource.addEventListener("class", function(e) {
        console.log('class type message: ');

        let json = JSON.parse(e.data),
            key = json.key,
            value = json.value;

        keys = document.querySelectorAll("#class-table tbody tr td:first-child");

        keys.forEach(
            function(v, index, obj) {
                if(key === v) {
                    console.log('match: ' + value);
                } else {
                    console.log('no match: ' + value + ', ' + index + ', ' + obj);
                }
            }
        );

        let row = classTableBody.insertRow(-1),
            cell = row.insertCell(0);
        cell.appendChild(document.createTextNode(key));

        cell = row.insertCell(1);
        cell.appendChild(document.createTextNode(value.location));

        cell = row.insertCell(2);
        cell.appendChild(document.createTextNode(value.category));
    });

    evtSource.onerror = function(e) {
        console.log('error')
        console.log(e)
    }
</script>

<script>
    let locationSelect = document.getElementById('location-select');
    fetch('proxy/rest/locations')
        .then(
            function(response) {
                if (response.status !== 200) {
                    console.warn('Error. Status Code: ' +
                        response.status);
                    return;
                }

                response.json().then(function(data) {
                    let option;

                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i];
                        locationSelect.add(option);
                    }

                    let other = locationSelect.cloneNode(true);
                    other.id = 'cloned-location-select';

                    let emptyOption = document.createElement('option');
                    emptyOption.selected = "selected";
                    other.insertBefore(emptyOption, other.options[0]);

                    document.getElementById("registered-location-select-span").appendChild(other);
                });
            }
        )
        .catch(function(err) {
            console.error('Fetch Error -', err);
        });


    let categorySelect = document.getElementById('category-select');
    fetch('proxy/rest/categories')
        .then(
            function(response) {
                if (response.status !== 200) {
                    console.warn('Error. Status Code: ' +
                        response.status);
                    return;
                }

                response.json().then(function(data) {
                    let option;

                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i];
                        categorySelect.add(option);
                    }

                    let other = categorySelect.cloneNode(true);
                    other.id = 'cloned-category-select';

                    let emptyOption = document.createElement('option');
                    emptyOption.selected = "selected";
                    other.insertBefore(emptyOption, other.options[0]);

                    document.getElementById("registered-category-select-span").appendChild(other);
                });
            }
        )
        .catch(function(err) {
            console.error('Fetch Error -', err);
        });



    let classSelect = document.getElementById('class-select');
    fetch('proxy/rest/classes')
        .then(
            function(response) {
                if (response.status !== 200) {
                    console.warn('Error. Status Code: ' +
                        response.status);
                    return;
                }

                response.json().then(function(data) {
                    let option;

                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i];
                        classSelect.add(option);
                    }
                });
            }
        )
        .catch(function(err) {
            console.error('Fetch Error -', err);
        });
</script>

</body>
</html>