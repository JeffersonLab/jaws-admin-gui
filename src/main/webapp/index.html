<html>
<body>
<h1>JAWS Web Proxy</h1>
<h2>Registered Alarms</h2>
<div>
    <form id="registered-form" onsubmit="return false;">
        <ul>
            <li>Alarm Name: <input type="text" name="name" value=""/></li>
            <li>Location: <span id="registered-location-select-span"></span></li>
            <li>Category: <span id="registered-category-select-span"></span></li>
            <li>Rationale: <input type="text" name="rationale" value=""/></li>
        </ul>

        <input id="registered-submit" type="button" value="Set"/>
    </form>
</div>
<script>
    let button = document.getElementById('registered-submit');

    button.addEventListener("click", function(e) {
        let form = document.getElementById("registered-form");

        let promise = fetch("proxy/rest/registered", {
            method: "PUT",
            body: new URLSearchParams(new FormData(form)),
            headers: {
                "Content-type": 'application/x-www-form-urlencoded;charset=UTF-8'
            }
        });

        form.reset();
    });
</script>
<table id="registered-table">
    <thead>
    <tr>
        <th>Alarm Name</th>
        <th>Location</th>
        <th>Category</th>
        <th>Rationale</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<h2>Alarm Classes</h2>
<div>
    <form id="class-form" onsubmit="return false;">
        <ul>
            <li>Class Name: <input type="text" name="name" value=""/></li>
            <li>Location: <select name="location" id="location-select"></select></li>
            <li>Category: <select name="category" id="category-select"></select></li>
        </ul>

        <input id="class-submit" type="button" value="Set"/>
    </form>
</div>
<script>
    let classButton = document.getElementById('class-submit');

    classButton.addEventListener("click", function(e) {
        let form = document.getElementById("class-form");

        let promise = fetch("proxy/rest/class", {
            method: "PUT",
            body: new URLSearchParams(new FormData(form)),
            headers: {
                "Content-type": 'application/x-www-form-urlencoded;charset=UTF-8'
            }
        });

        form.reset();
    });
</script>
<table id="class-table">
    <thead>
        <tr>
            <th>Class Name</th>
            <th>Location</th>
            <th>Category</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<script>
    let evtSource = new EventSource('proxy/sse'),
        registeredTable = document.getElementById('registered-table'),
        registeredTableBody = registeredTable.getElementsByTagName("tbody")[0],
        classTable = document.getElementById('class-table');
        classTableBody = classTable.getElementsByTagName("tbody")[0];

    console.log('attempting sse...')

    evtSource.addEventListener("registration", function(e) {
        console.log('registration type message')
        let json = JSON.parse(e.data),
            key = json.key,
            value = json.value;

        console.log(json);

        keys = document.querySelectorAll("#registered-table tbody tr td:first-child");

        keys.forEach(
            function(td, index, list) {
                if(key === td.textContent) {
                    console.log('match: ', key, td.textContent);
                    registeredTableBody.deleteRow(index);
                } else {
                    console.log('no match: ', key, td.textContent, index, list);
                }
            }
        );

        let row = registeredTableBody.insertRow(-1),
            cell = row.insertCell(0);
        cell.appendChild(document.createTextNode(key));

        let location = value.location;
        if(location != null) {
            location = Object.values(location)[0];
        }
        cell = row.insertCell(1);
        cell.appendChild(document.createTextNode(location));

        let category = value.category;
        if(category != null) {
            category = Object.values(category)[0];
        }
        cell = row.insertCell(2);
        cell.appendChild(document.createTextNode(category));

        let rationale = value.rationale;
        if(rationale != null) {
            rationale = Object.values(rationale)[0];
        }
        cell = row.insertCell(3);
        cell.appendChild(document.createTextNode(rationale));
    });

    evtSource.addEventListener("class", function(e) {
        console.log('class type message: ');

        let json = JSON.parse(e.data),
            key = json.key,
            value = json.value;

        keys = document.querySelectorAll("#class-table tbody tr td:first-child");

        keys.forEach(
            function(v, index, obj) {
                if(key === v) {
                    console.log('match: ' + value);
                } else {
                    console.log('no match: ' + value + ', ' + index + ', ' + obj);
                }
            }
        );

        let row = classTableBody.insertRow(-1),
            cell = row.insertCell(0);
        cell.appendChild(document.createTextNode(key));

        cell = row.insertCell(1);
        cell.appendChild(document.createTextNode(value.location));

        cell = row.insertCell(2);
        cell.appendChild(document.createTextNode(value.category));
    });

    evtSource.onerror = function(e) {
        console.log('error')
        console.log(e)
    }
</script>

<script>
    let locationSelect = document.getElementById('location-select');
    fetch('proxy/rest/locations')
        .then(
            function(response) {
                if (response.status !== 200) {
                    console.warn('Error. Status Code: ' +
                        response.status);
                    return;
                }

                response.json().then(function(data) {
                    let option;

                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i];
                        locationSelect.add(option);
                    }

                    let other = locationSelect.cloneNode(true);
                    other.id = 'cloned-location-select';
                    document.getElementById("registered-location-select-span").appendChild(other);
                });
            }
        )
        .catch(function(err) {
            console.error('Fetch Error -', err);
        });


    let categorySelect = document.getElementById('category-select');
    fetch('proxy/rest/categories')
        .then(
            function(response) {
                if (response.status !== 200) {
                    console.warn('Error. Status Code: ' +
                        response.status);
                    return;
                }

                response.json().then(function(data) {
                    let option;

                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i];
                        categorySelect.add(option);
                    }

                    let other = categorySelect.cloneNode(true);
                    other.id = 'cloned-category-select';
                    document.getElementById("registered-category-select-span").appendChild(other);
                });
            }
        )
        .catch(function(err) {
            console.error('Fetch Error -', err);
        });
</script>

</body>
</html>